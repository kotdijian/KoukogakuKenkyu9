---
## 考古学研究9
#### 第7回目(2025/5/28)

# 第7回：QGISを用いた地理空間情報分析実習2

[授業ページトップに戻る](https://kotdijian.github.io/KoukogakuKenkyu9/)


### 1.基本設定
#### QGISのセットアップ

- ダウンロードサイト：https://www.qgis.org/download/
    * LTR (Long Term Release) またはLong Term Versionをインストールする
- 解説：https://qgis.mierune.co.jp/posts/howto_1_install_qgis

#### QGISを起動する

- 起動画面で「新規プロジェクト」を選択する。またはツールバーの「新規プロジェクト」ボタンをクリックするか、メニュー「プロジェクト」から「新規」を選択する
- 解説：https://qgis.mierune.co.jp/posts/howto_1_about_screen

#### プロジェクトのCRSを設定する

- CRS (Coordinates Reference System：座標参照系) は、地図や地物の位置や形状を描画するときの基準
- 球体としての地球の中心を原点として角度（緯度・経度）で位置を示す地理（地心）座標系と、球体の表面の特定の範囲に投影された平面を直角に区分して位置を示す平面直角座標系（投影座標系とも）がある
- CRSはEPSGコードと呼ばれる国際的な標準コードで整理されている
  - EPSG4326 (WGS84)　地球規模の範囲をカバーする地理座標系、GPS/GNSSでも使用される。単位は度
  - EPSG3857 (Webメルカトル）　Web地図などで用いられる投影座標系。地球規模の範囲を正方形で表示。単位はm。
  - EPSG6668 (JGD2011) WGS84に基づき定められたJGD2000を、東日本大震災後に改訂したもの。地理座標系。単位は度。
  - EPSG6669〜6687 (JGD2011平面直角座標系／国土座標） 日本全体をI〜XIXの19の区域に区分した平面直角座標系。単位はm。東京都はIX系 (EPSG6677)に含まれる。
- メニュー「プロジェクト」から「プロパティ」を開き、「CRS（座標参照系）」タブで設定
  - 今回はEPSG3857で


- **オンザフライ**：QGISは異なる座標系のデータも自動的にプロジェクトのCRSで表示する機能を持っている。ただし有効でない場合も。
- 地図や地物がうまく表示されない時はレイヤのプロパティ（またはレイヤのCRS）から修正する

- 国土地理院：日本の測地系　https://www.gsi.go.jp/sokuchikijun/datum-main.html
- 解説：https://qgis.mierune.co.jp/posts/howto_set_crs
- トラブルシューティング：https://qgis.mierune.co.jp/posts/howto_crs_faq

---
### 2. 地図の表示

#### タイル地図を表示する

- ブラウザパネルの"XYZ Tiles"を右クリックして「新規接続」を選択
    - 例）地理院標準地図＝"https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png"
- 「名前」にタイル地図の名称、「URL」にタイル地図のURLを入力する
    - 地理院タイル一覧：https://maps.gsi.go.jp/development/ichiran.html
    - すでに目的のタイル地図がブラウザパネルにある場合はダブルクリック
- 国土地理院：地理院タイルについて　https://maps.gsi.go.jp/development/siyou.html
- 解説：https://qgis.mierune.co.jp/posts/howto_1_add_xyztiles

#### ラスタデータを読み込む
1. 位置情報を含むGeoTiffファイル等をマップキャンパス（メインの地図画面）にドラッグ&ドロップする
2. またはメニュー「レイヤ」から「レイヤを追加」>「ラスタレイヤを追加」を選択し、表示されるパネルの「ソース」セクションの「ラスタデータセット」で開くファイルを指定する
   * 複数のファイルに分割されている場合、レイヤをグループ化すると便利

#### ラスタデータを読み込む2:
0. DEM=Digital Elevation Model（数値標高モデル）、指定された区画（メッシュ）内の地表の標高（代表値）データで構成された地理空間情報
1. 基盤地図情報ダウンロードサービスからDEMデータをダウンロードする
     - 基盤地図情報ダウンロードサービス：https://service.gsi.go.jp/kiban/
     - 初回アカウント登録が必要
     - 1m、5m、10mメッシュのデータがある。メッシュが小さいほどモデルは細かいが、同じ面積に対してデータサイズが大きくなる
     - 今回は10mメッシュ(10B)をダウンロード
     - 地図上のグリッドをクリックして範囲を指定、ダウンロード
2. ダウンロードデータを解凍し確認する
     - 拡張子.xmlのファイルでGeoTiffではない！
     - XMLをGeoTiffに変換するプラグイン(QuickDEM4JP)がある！ https://qiita.com/nokonoko_1203/items/b99aa733cb215305f8aa
3. ダウンロードしたXMLをまとめて一つのGeoTiffに変換し、ラスタレイヤに追加する
      - メニュー「ラスタ」から「その他」>「結合(gdal merge)」を選択、結合するレイヤと書き出し先を指定

#### ラスタデータの表示を変える
1. 「レイヤのプロパティ」>「シンボロジ」
2. レンダリングタイプの選択
   - 単バンドグレー
   - 単バンド擬似カラー
   - 陰影図 (hillshade)
   - 投稿線 (contours)
3. 単バンド擬似カラーでカラーランプを選択、編集する

#### ベクタデータ（ポイントデータを含む）を読み込む
1. 正しい形式のベクタデータふぁいるをマップキャンパスにドロップする
2. またはメニュー「レイヤ」から「レイヤを追加」>「ベクタレイヤを追加」を選択し、表示されるパネルの「ソース」セクションの「ベクタデータセット」で開くファイルを指定、「追加」をクリックする
3. CSV形式のポイントデータの場合、 メニュー「レイヤ」から「レイヤを追加」>「CSVテキストレイヤを追加」を選択し、表示されるパネルの「ファイル名」で開くファイルを指定 > 「ジオメトリ定義」で「ポイント座標」を選択しX値・Y値に該当するフィールドを指定し「追加」をクリックする

#### ベクタデータを読み込む2
1. 土地分類調査データをダウンロードする
      - 国土数値情報ダウンロードサービス：https://nlftp.mlit.go.jp/kokjo/inspect/landclassification/download.html
      - 東京都・埼玉県・千葉県を選択してダウンロード（他は任意）
2. 地形区分（ポリゴン）.shpをマップキャンパスにドロップ、またはメニュー「レイヤ」から「ベクタレイヤを追加」
      - .shpはシェープファイルの拡張子。.shxや.dbfが必須
      - DEMデータと異なり範囲を多角形（ポリゴン）で区切ったベクタデータ。範囲全体に一意の属性が与えられる
3. 都道府県別データを結合する
      - メニュー「ベクタ」から「データ管理ツール」>「ベクタレイヤを結合」
      - 結合後のデータはあらかじめ.gkpgデータベースとして保存設定するか、一時レイヤとして作成してから保存する
4. 表示の変更
      - レイヤ名をダブルクリックまたは右クリック→プロパティ→シンボロジ
      - 「カテゴリ値による定義」を選択、色分けしたい属性テーブルの項目を値(Value)に設定
      - カラーランプを選択（任意）→「分類」をクリック
      - 
6. 

